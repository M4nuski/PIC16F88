	
;#############################################################################
;	KEYPAD
;#############################################################################

PROCESS_KEYS:
	BTFSC	keypad_status, bit_keyEntry	; skip unit toggle in entry mode
	GOTO	PROCESS_KEYS_s1
	
	BTFSC	pin_SWITCH		; clear when pressed
	GOTO	PROCESS_KEYS_sUp
	
PROCESS_KEYS_sSown:
	; check if already down
	BTFSS	keypad_status, bit_keySwitchLast
	GOTO	PROCESS_KEYS_s1	

	MOVLW	mask_statusUnit
	XORWF	data_status, F	; toggle current unit bit
	;MOVLW	'K'
	;CALL	SEND_BYTE
	;MOVF	data_status, W	
	;CALL	SEND_BYTE
	BCF	keypad_status, bit_keySwitchLast
	GOTO	PROCESS_KEYS_s1
	
PROCESS_KEYS_sUp:
	BSF	keypad_status, bit_keySwitchLast
	
PROCESS_KEYS_s1:
	; scan keypad
	
	CLRF	data_0
	
	BSF	pin_KEYPAD_OUTPUT	; read bit to 1
	CALL	WAIT_50us
	BCF	pin_KEYPAD_CLOCK
	CALL	WAIT_50us
	BSF	pin_KEYPAD_CLOCK
	CALL	WAIT_50us
	
	BTFSC	pin_KEYPAD_INPUT
	BSF	data_0, 0	
	BCF	pin_KEYPAD_OUTPUT	; read bit to 0	
	
	MOVLW	7			; loop for the 7 remaining bits
	MOVWF	loop_count
PROCESS_KEYS_scanloop:
	BCF	STATUS, C
	RLF	data_0, F
	
	CALL	WAIT_50us
	BCF	pin_KEYPAD_CLOCK
	CALL	WAIT_50us
	BSF	pin_KEYPAD_CLOCK
	CALL	WAIT_50us
	
	BTFSC	pin_KEYPAD_INPUT
	BSF	data_0, 0
		
	DECFSZ	loop_count, F
	GOTO	PROCESS_KEYS_scanloop

	; check data valid
	
	CLRF	data_2		; clear 2 for count
	MOVF	data_0, W	; copy data to 1, will be destroyed when counting
	MOVWF	data_1
	
	MOVLW	8
	MOVWF	loop_count
PROCESS_KEYS_bitloop:
	BCF	STATUS, C
	RRF	data_1, F
	BTFSC	STATUS, C
	INCF	data_2, F
	DECFSZ	loop_count, F
	GOTO	PROCESS_KEYS_bitloop
	
	MOVF	data_2, W
	SUBLW	2		; no valid key if bit count !=2
	BR_EQ	PROCESS_KEYS_decode
	BSF	keypad_key, bit_keyUp ; mark as different
	GOTO	PROCESS_KEYS_validate
	
	
PROCESS_KEYS_decode:
		
	; data_0 now has valid keypad scan
	
	; 0001 0001 0
	; 0001 0010 1
	; 0001 0100 2
	; 0001 1000 3
	
	; 0010 0001 4
	; 0010 0010 5 
	; 0010 0100 6
	; 0010 1000 7
	CLRW
	; 0 of bit 0 is implied
	BTFSC	data_0, 1
	MOVLW	1
	BTFSC	data_0, 2
	MOVLW	2
	BTFSC	data_0, 3
	MOVLW	3

	MOVWF	keypad_key
	
	CLRW
	BTFSC	data_0, 5
	MOVLW	4
	BTFSC	data_0, 6
	MOVLW	8
	BTFSC	data_0, 7
	MOVLW	12
	
	ADDWF	keypad_key, F ; key now has the key number	
	
PROCESS_KEYS_validate:
	MOVF	keypad_key, W
	XORWF	keypad_last, W
	SK_NE
	BSF	keypad_key, bit_keyRepeat ;mark bit if repeat

	MOVF	keypad_key, W
	MOVWF	keypad_last
	BCF	keypad_last, bit_keyRepeat
	
;#############################################################################
;	Process Commands
;#############################################################################

	
	; MOVF	keypad_key, W
; SEND_BYTEcmd:	; send byte to UART, blocking
	; BTFSS	PIR1, TXIF
	; GOTO	SEND_BYTEcmd
	; MOVWF	TXREG

	MOVLW	15 ; TODO update to 4x5
	SUBWF	keypad_key, W
	BR_GT	PROCESS_KEYS_END
	

	PC0x0100SKIP
	MOVLW	HIGH (PROCESS_KEYS_00)
	MOVWF	PCLATH

; from PCB version 1.1 ; TODO update to 4x5 keypad
;
;	15[1]	11[2]	7 [3]	3 [A]
;	14[4]	10[5]	6 [6]	2 [B]
;	13[7]	9 [8]	5 [9]	1 [C]
;	12[*]	8 [0]	4 [#]	0 [D]
;

	MOVF	keypad_key, W
	ADDWF	PCL, F
	GOTO	PROCESS_KEYS_15
	GOTO	PROCESS_KEYS_11
	GOTO	PROCESS_KEYS_07
	GOTO	PROCESS_KEYS_03
	
	GOTO	PROCESS_KEYS_14
	GOTO	PROCESS_KEYS_10
	GOTO	PROCESS_KEYS_06
	GOTO	PROCESS_KEYS_02
	
	GOTO	PROCESS_KEYS_13
	GOTO	PROCESS_KEYS_09
	GOTO	PROCESS_KEYS_05
	GOTO	PROCESS_KEYS_01
	
	GOTO	PROCESS_KEYS_12
	GOTO	PROCESS_KEYS_08
	GOTO	PROCESS_KEYS_04
	GOTO	PROCESS_KEYS_00

	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_00:
	; key 00[7]
	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END	
	RNLc	dro_offset_0
	MOVLW	7
	IORWF	dro_offset_0, F

	GOTO	PROCESS_KEYS_END
PROCESS_KEYS_01:
	; key 01[8]
	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END	
	RNLc	dro_offset_0
	MOVLW	8
	IORWF	dro_offset_0, F

	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_02:
	; key 00[9]
	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END	
	RNLc	dro_offset_0
	MOVLW	9
	IORWF	dro_offset_0, F

	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_03:
	; key 03[A] for DRO0 select

	BTFSC	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_03_reset
	
	BSF	keypad_status, bit_keyEntry
	BSF	keypad_status, bit_keyEntry0
	BCF	keypad_status, bit_keySign

	CLRF	dro_offset_0
	CLRF	dro_offset_1
	CLRF	dro_offset_2
	
	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_03_reset:
	BCF	keypad_status, bit_keyEntry
	BCF	keypad_status, bit_keyEntry0
	BCF	keypad_status, bit_keyEntry1
	BCF	keypad_status, bit_keyEntry2
	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_04:
	; key 04[4]
	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END	
	RNLc	dro_offset_0
	MOVLW	4
	IORWF	dro_offset_0, F

	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_05:
	; key 05[5]
	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END	
	RNLc	dro_offset_0
	MOVLW	5
	IORWF	dro_offset_0, F

	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_06:
	; key 06[6]

	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END	
	RNLc	dro_offset_0
	MOVLW	6
	IORWF	dro_offset_0, F

	GOTO	PROCESS_KEYS_END

PROCESS_KEYS_07:	
	; key 07[B] for DRO1 select
	
	BTFSC	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_07_reset
	
	BSF	keypad_status, bit_keyEntry
	BSF	keypad_status, bit_keyEntry1
	BCF	keypad_status, bit_keySign

	CLRF	dro_offset_0
	CLRF	dro_offset_1
	CLRF	dro_offset_2
	
	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_07_reset:
	BCF	keypad_status, bit_keyEntry 
	BCF	keypad_status, bit_keyEntry0
	BCF	keypad_status, bit_keyEntry1
	BCF	keypad_status, bit_keyEntry2
	GOTO	PROCESS_KEYS_END



PROCESS_KEYS_08:
	; key 08[1]

	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END	
	RNLc	dro_offset_0
	MOVLW	1
	IORWF	dro_offset_0, F

	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_09:
	; key 09[2]

	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END	
	RNLc	dro_offset_0
	MOVLW	2
	IORWF	dro_offset_0, F

	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_10:
	; key 06[3]

	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END	
	RNLc	dro_offset_0
	MOVLW	3
	IORWF	dro_offset_0, F

	GOTO	PROCESS_KEYS_END

PROCESS_KEYS_11:

	GOTO	PROCESS_KEYS_END
	; NOT IMPLEMENTED
	; BTFSC	keypad_status, bit_keyEntry
	; GOTO	PROCESS_KEYS_11_reset
	
	; BSF	keypad_status, bit_keyEntry
	; BSF	keypad_status, bit_keyEntry2
	; BCF	keypad_status, bit_keySign

	; CLRF	dro_offset_0
	; CLRF	dro_offset_1
	; CLRF	dro_offset_2
	
	; GOTO	PROCESS_KEYS_END
	
; PROCESS_KEYS_11_reset:
	; BCF	keypad_status, bit_keyEntry 
	; BCF	keypad_status, bit_keyEntry0
	; BCF	keypad_status, bit_keyEntry1
	; BCF	keypad_status, bit_keyEntry2
	; GOTO	PROCESS_KEYS_END
	
	
	
PROCESS_KEYS_12:
	; key 12[*] for 1/2 function
	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END	
	
	BCF	keypad_status, bit_keyEntry 
	
	BTFSC	keypad_status, bit_keyEntry0
	GOTO	PROCESS_KEYS_12_dro0
	BTFSC	keypad_status, bit_keyEntry1
	GOTO	PROCESS_KEYS_12_dro1
	BTFSC	keypad_status, bit_keyEntry2
	GOTO	PROCESS_KEYS_12_dro2	
	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_12_dro0:
	MOVc	dro0_0, data_0
	ADDc	data_0, dro0_offset_0
	BCF	STATUS, C
	RRFc	data_0	
	BTFSC	data_2, 6
	BSF	data_2, 7
	SUBc	data_0, dro0_0	
	MOVc	data_0, dro0_offset_0
 		
	BCF	keypad_status, bit_keyEntry0
	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_12_dro1:
	MOVc	dro1_0, data_0
	ADDc	data_0, dro1_offset_0
	BCF	STATUS, C
	RRFc	data_0	
	BTFSC	data_2, 6
	BSF	data_2, 7
	SUBc	data_0, dro1_0	
	MOVc	data_0, dro1_offset_0
		
	BCF	keypad_status, bit_keyEntry1
	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_12_dro2:
	MOVc	dro2_0, data_0
	ADDc	data_0, dro2_offset_0
	BCF	STATUS, C
	RRFc	data_0	
	BTFSC	data_2, 6
	BSF	data_2, 7
	SUBc	data_0, dro2_0	
	MOVc	data_0, dro2_offset_0
	BCF	keypad_status, bit_keyEntry2
	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_13:
	; key 13[0]

	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END	
	RNLc	dro_offset_0
	MOVLW	0
	IORWF	dro_offset_0, F

	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_14:
	; key 14[-] for minus sign
	BTFSS	keypad_status, bit_keyEntry
	GOTO	PROCESS_KEYS_END
	
	MOVLW	mask_keySign
	XORWF	keypad_status, F
	
	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_15:
	; key 15[D] for accept

	BTFSS	keypad_status, bit_keyEntry 	; was in entry mode?
	GOTO	PROCESS_KEYS_END
	
	BCF	keypad_status, bit_keyEntry 
	
	; convert bcd+sign to binary in 2's complement
	MOVc	dro_offset_0, data_BCD0
	BCF	PCLATH, 3
	CALL	BCD2BIN
	BSF	PCLATH, 3
	
	; convert to mm if input was inches
	BTFSS	data_status, bit_statusUnit
	GOTO	PROCESS_KEYS_15_skipM2p54
	BCF	PCLATH, 3
	CALL	MULT_2p54
	BSF	PCLATH, 3
	
PROCESS_KEYS_15_skipM2p54:
	BTFSS	keypad_status, bit_keySign
	GOTO	PROCESS_KEYS_15_0
	NEGc	data_0
	
PROCESS_KEYS_15_0:
	BTFSC	keypad_status, bit_keyEntry0
	GOTO	PROCESS_KEYS_15_accept0
	BTFSC	keypad_status, bit_keyEntry1
	GOTO	PROCESS_KEYS_15_accept1
	BTFSC	keypad_status, bit_keyEntry2
	GOTO	PROCESS_KEYS_15_accept2
	
	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_15_accept0:
	SUBc	data_0, dro0_0	
	MOVc	data_0, dro0_offset_0

	BCF	keypad_status, bit_keyEntry0
	GOTO	PROCESS_KEYS_END

PROCESS_KEYS_15_accept1:
	SUBc	data_0, dro1_0
	MOVc	data_0, dro1_offset_0
	
	BCF	keypad_status, bit_keyEntry1
	GOTO	PROCESS_KEYS_END
	
PROCESS_KEYS_15_accept2:
	SUBc	data_0, dro2_0
	MOVc	data_0, dro2_offset_0
	
	BCF	keypad_status, bit_keyEntry2
	GOTO	PROCESS_KEYS_END	
	
PROCESS_KEYS_END:
	CLRF	PCLATH
	RETURN

